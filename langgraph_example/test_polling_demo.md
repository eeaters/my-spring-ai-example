# 邮件轮训机制演示

## 功能概述

已经成功实现了基于定时任务的邮件轮训机制，替代了原有的同步等待方式。

## 核心组件

### 1. WorkflowExecution 实体
- 持久化工作流执行状态
- 支持指数退避重试策略
- 跟踪执行历史和重试次数

### 2. WorkflowExecutionService 服务
- 管理工作流执行的生命周期
- 提供状态查询和更新功能
- 支持清理过期执行记录

### 3. EmailPollingScheduler 定时任务
- **每30秒**检查一次等待邮件回复的任务
- **每5分钟**清理过期的执行记录
- 自动恢复收到邮件的工作流

### 4. 增强的 WaitForReplyNode
- 没有新邮件时创建持久化等待状态
- 生成唯一的线程ID用于工作流恢复
- 避免阻塞主工作流线程

## 工作流程

```
1. 创建任务 → 发送邮件 → 等待回复
                    ↓
2. 没有新邮件 → 创建WorkflowExecution(状态=WAITING_FOR_REPLY)
                    ↓
3. 工作流暂停，定时任务开始轮训
                    ↓
4. 定时任务(每30秒)检查邮箱
                    ↓
5. 收到邮件 → 更新任务状态 → 恢复工作流
                    ↓
6. 继续下一步(发送确认/最终同意/终止)
```

## API端点

系统提供了REST API来监控轮训状态：

- `GET /api/workflow/status` - 获取整体状态统计
- `GET /api/workflow/executions` - 获取所有执行记录
- `GET /api/workflow/waiting` - 获取等待中的任务

## 重试策略

采用**指数退避算法**：
- 第1次重试：1分钟后
- 第2次重试：2分钟后
- 第3次重试：4分钟后
- 第4次重试：8分钟后
- 最大间隔：30分钟

## 优势

1. **非阻塞**：主工作流不会被邮件等待阻塞
2. **可扩展**：支持并发处理多个等待任务
3. **容错性**：任务状态持久化，应用重启不丢失
4. **高效**：智能重试策略，避免频繁轮训
5. **监控友好**：提供详细的状态查询接口

## 测试方法

1. 启动应用：`mvn spring-boot:run`
2. 创建新任务（选择选项1）
3. 系统会自动发送邮件并开始等待
4. 每30秒定时任务会检查邮箱
5. 收到回复后自动恢复工作流

可以通过访问 `http://localhost:8080/api/workflow/status` 来查看当前的轮训状态。